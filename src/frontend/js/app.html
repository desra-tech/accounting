<script>
// ==================== GLOBAL VARIABLES ====================
let currentUser = null;
let currentCompany = null;
let accounts = [];
let customers = [];
let suppliers = [];
let products = [];

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
});

async function initializeApp() {
  showLoading();
  try {
    await loadUserInfo();
    setupEventListeners();
    loadDashboardData();
  } catch (error) {
    console.error('Error initializing app:', error);
    showNotification('Error', 'Gagal memuat aplikasi: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}

// ==================== USER & AUTH ====================
async function loadUserInfo() {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.user) {
          currentUser = result.user;
          currentCompany = result.company;
          updateUserDisplay();
          setupRoleBasedAccess();
          resolve();
        } else {
          reject(new Error('User not authenticated'));
        }
      })
      .withFailureHandler(reject)
      .getUserInfo();
  });
}

function updateUserDisplay() {
  if (currentUser) {
    document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
    document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Admin' : 'User';
  }
  if (currentCompany) {
    document.getElementById('companyName').textContent = currentCompany.name;
  }
}

function setupRoleBasedAccess() {
  // Hide admin-only menu items for non-admin users
  if (currentUser.role !== 'admin') {
    document.querySelectorAll('[data-role="admin"]').forEach(el => {
      el.style.display = 'none';
    });
  }
}

// ==================== EVENT LISTENERS ====================
function setupEventListeners() {
  // Navigation
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      const page = this.dataset.page;
      showPage(page);
    });
  });

  // Tabs
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('tab-btn')) {
      const tabName = e.target.dataset.tab;
      const parent = e.target.closest('.tabs').nextElementSibling;

      // Remove active class from all tabs
      e.target.closest('.tabs').querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      e.target.classList.add('active');

      // Show corresponding tab pane
      parent.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
      });
      const targetPane = parent.querySelector('#' + tabName + '-tab');
      if (targetPane) {
        targetPane.classList.add('active');
      }

      // Load data for specific tabs
      handleTabChange(tabName);
    }
  });
}

function handleTabChange(tabName) {
  switch(tabName) {
    case 'accounts':
      loadAccounts();
      break;
    case 'customers':
      loadCustomers();
      break;
    case 'suppliers':
      loadSuppliers();
      break;
    case 'products':
      loadProducts();
      break;
  }
}

// ==================== PAGE NAVIGATION ====================
function showPage(pageName) {
  // Hide all pages
  document.querySelectorAll('.page').forEach(page => {
    page.classList.remove('active');
  });

  // Show selected page
  const targetPage = document.getElementById(pageName + '-page');
  if (targetPage) {
    targetPage.classList.add('active');
  }

  // Update active nav item
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  const activeNavItem = document.querySelector(`.nav-item[data-page="${pageName}"]`);
  if (activeNavItem) {
    activeNavItem.classList.add('active');
  }

  // Load page data
  loadPageData(pageName);
}

function loadPageData(pageName) {
  switch(pageName) {
    case 'dashboard':
      loadDashboardData();
      break;
    case 'master-data':
      loadAccounts();
      break;
    case 'journal':
      loadJournals();
      break;
    case 'reports':
      loadReports();
      break;
    case 'inventory':
      loadInventory();
      break;
    case 'debt-receivable':
      loadDebtReceivable();
      break;
  }
}

// ==================== DASHBOARD ====================
function loadDashboardData() {
  loadDashboardStats();
  loadWarnings();
}

async function loadDashboardStats() {
  try {
    // Get balance sheet for current cash
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          const data = result.data;
          // Find cash and bank accounts
          const cashAccounts = data.assets.filter(acc =>
            acc.code === '1-1001' || acc.code === '1-1002'
          );
          const totalCash = cashAccounts.reduce((sum, acc) => sum + acc.balance, 0);
          document.getElementById('totalCash').textContent = formatCurrency(totalCash);
        }
      })
      .ReportsAPI.generateBalanceSheet(new Date().toISOString());

    // Get income statement for current month
    const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
    const lastDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0);

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          const data = result.data;
          document.getElementById('monthlyRevenue').textContent = formatCurrency(data.totalRevenue);
          document.getElementById('monthlyExpense').textContent = formatCurrency(data.totalExpense);
          document.getElementById('monthlyProfit').textContent = formatCurrency(data.netProfit);
        }
      })
      .ReportsAPI.generateIncomeStatement(
        firstDayOfMonth.toISOString(),
        lastDayOfMonth.toISOString()
      );
  } catch (error) {
    console.error('Error loading dashboard stats:', error);
  }
}

function loadWarnings() {
  const warningList = document.getElementById('warningList');
  warningList.innerHTML = '';

  // Check low stock products
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success && result.data.length > 0) {
        result.data.forEach(product => {
          const warning = document.createElement('div');
          warning.className = 'alert alert-warning mb-2';
          warning.innerHTML = `
            <strong>⚠️ Stok Rendah:</strong> ${product.name}
            (Stok: ${product.stock} ${product.unit}, Min: ${product.minStock})
          `;
          warningList.appendChild(warning);
        });
      } else {
        warningList.innerHTML = '<p class="text-muted">Tidak ada peringatan</p>';
      }
    })
    .InventoryAPI.getLowStockProducts();

  // Check overdue receivables
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        const overdue = [...result.data.overdue1_30, ...result.data.overdue31_60,
                        ...result.data.overdue61_90, ...result.data.overdue90plus];
        if (overdue.length > 0) {
          const warning = document.createElement('div');
          warning.className = 'alert alert-danger mb-2';
          warning.innerHTML = `<strong>⚠️ Piutang Jatuh Tempo:</strong> ${overdue.length} piutang belum dibayar`;
          warningList.appendChild(warning);
        }
      }
    })
    .DebtReceivableAPI.getReceivableAging();
}

// ==================== MASTER DATA ====================
// Load Accounts
function loadAccounts(filters = null) {
  showLoading();
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        accounts = result.data;
        renderAccountsTable(accounts);
      } else {
        showNotification('Error', result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showNotification('Error', 'Gagal memuat data akun: ' + error.message, 'error');
    })
    .MasterDataAPI.getAccounts(filters);
}

function renderAccountsTable(data) {
  const tbody = document.getElementById('accountsTable');
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada data</td></tr>';
    return;
  }

  tbody.innerHTML = data.map(account => `
    <tr>
      <td><code>${account.code}</code></td>
      <td>${account.name}</td>
      <td><span class="badge">${getCategoryLabel(account.category)}</span></td>
      <td>${account.type === 'header' ? 'Header' : 'Detail'}</td>
      <td class="text-right">${formatCurrency(account.balance || 0)}</td>
      <td>
        <button class="btn btn-sm btn-info" onclick="viewAccountDetail('${account.id}')">Detail</button>
        ${currentUser.role === 'admin' ? `
          <button class="btn btn-sm btn-warning" onclick="editAccount('${account.id}')">Edit</button>
        ` : ''}
      </td>
    </tr>
  `).join('');
}

// Load Customers
function loadCustomers() {
  showLoading();
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        customers = result.data;
        renderCustomersTable(customers);
      } else {
        showNotification('Error', result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showNotification('Error', 'Gagal memuat data pelanggan: ' + error.message, 'error');
    })
    .MasterDataAPI.getCustomers();
}

function renderCustomersTable(data) {
  const tbody = document.getElementById('customersTable');
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Tidak ada data</td></tr>';
    return;
  }

  tbody.innerHTML = data.map(customer => `
    <tr>
      <td><code>${customer.code}</code></td>
      <td>${customer.name}</td>
      <td>${customer.phone || '-'}</td>
      <td>${customer.email || '-'}</td>
      <td>${customer.address || '-'}</td>
      <td class="text-right">${formatCurrency(customer.balance || 0)}</td>
      <td>
        ${currentUser.role === 'admin' ? `
          <button class="btn btn-sm btn-warning" onclick="editCustomer('${customer.id}')">Edit</button>
        ` : ''}
      </td>
    </tr>
  `).join('');
}

// Load Suppliers
function loadSuppliers() {
  showLoading();
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        suppliers = result.data;
        renderSuppliersTable(suppliers);
      } else {
        showNotification('Error', result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showNotification('Error', 'Gagal memuat data pemasok: ' + error.message, 'error');
    })
    .MasterDataAPI.getSuppliers();
}

function renderSuppliersTable(data) {
  const tbody = document.getElementById('suppliersTable');
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Tidak ada data</td></tr>';
    return;
  }

  tbody.innerHTML = data.map(supplier => `
    <tr>
      <td><code>${supplier.code}</code></td>
      <td>${supplier.name}</td>
      <td>${supplier.phone || '-'}</td>
      <td>${supplier.email || '-'}</td>
      <td>${supplier.address || '-'}</td>
      <td class="text-right">${formatCurrency(supplier.balance || 0)}</td>
      <td>
        ${currentUser.role === 'admin' ? `
          <button class="btn btn-sm btn-warning" onclick="editSupplier('${supplier.id}')">Edit</button>
        ` : ''}
      </td>
    </tr>
  `).join('');
}

// Load Products
function loadProducts() {
  showLoading();
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        products = result.data;
        renderProductsTable(products);
      } else {
        showNotification('Error', result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showNotification('Error', 'Gagal memuat data produk: ' + error.message, 'error');
    })
    .MasterDataAPI.getProducts();
}

function renderProductsTable(data) {
  const tbody = document.getElementById('productsTable');
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center">Tidak ada data</td></tr>';
    return;
  }

  tbody.innerHTML = data.map(product => `
    <tr>
      <td><code>${product.code}</code></td>
      <td>${product.name}</td>
      <td>${product.type === 'product' ? 'Barang' : 'Jasa'}</td>
      <td>${product.unit}</td>
      <td class="text-right">${formatCurrency(product.purchasePrice || 0)}</td>
      <td class="text-right">${formatCurrency(product.sellingPrice || 0)}</td>
      <td class="text-right">${product.stock || 0}</td>
      <td>
        ${currentUser.role === 'admin' ? `
          <button class="btn btn-sm btn-warning" onclick="editProduct('${product.id}')">Edit</button>
        ` : ''}
      </td>
    </tr>
  `).join('');
}

// ==================== PLACEHOLDER FUNCTIONS ====================
// These will be implemented in detail
function loadJournals() {
  console.log('Loading journals...');
}

function loadReports() {
  console.log('Loading reports...');
}

function loadInventory() {
  console.log('Loading inventory...');
}

function loadDebtReceivable() {
  console.log('Loading debt & receivable...');
}

function showReceiptForm() {
  console.log('Show receipt form');
}

function showExpenseForm() {
  console.log('Show expense form');
}

function showCapitalForm() {
  console.log('Show capital form');
}

function showAddAccountForm() {
  console.log('Show add account form');
}

function showAddCustomerForm() {
  console.log('Show add customer form');
}

function showAddSupplierForm() {
  console.log('Show add supplier form');
}

function showAddProductForm() {
  console.log('Show add product form');
}

function viewAccountDetail(id) {
  console.log('View account detail:', id);
}

function editAccount(id) {
  console.log('Edit account:', id);
}

function editCustomer(id) {
  console.log('Edit customer:', id);
}

function editSupplier(id) {
  console.log('Edit supplier:', id);
}

function editProduct(id) {
  console.log('Edit product:', id);
}

// ==================== UTILITY FUNCTIONS ====================
function formatCurrency(amount) {
  return new Intl.NumberFormat('id-ID', {
    style: 'currency',
    currency: 'IDR',
    minimumFractionDigits: 0
  }).format(amount);
}

function formatDate(date) {
  if (!date) return '-';
  const d = new Date(date);
  return d.toLocaleDateString('id-ID', {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  });
}

function getCategoryLabel(category) {
  const labels = {
    'asset': 'Aset',
    'liability': 'Kewajiban',
    'equity': 'Ekuitas',
    'revenue': 'Pendapatan',
    'cogs': 'HPP',
    'expense': 'Beban',
    'other': 'Lainnya'
  };
  return labels[category] || category;
}

function showLoading() {
  document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('active');
}

function showNotification(title, message, type = 'info') {
  alert(`${title}\n\n${message}`);
  // TODO: Implement proper notification system
}

// ==================== MODAL FUNCTIONS ====================
function showModal(title, content) {
  const modalContainer = document.getElementById('modalContainer');
  modalContainer.innerHTML = `
    <div class="modal active">
      <div class="modal-dialog">
        <div class="modal-header">
          <h3>${title}</h3>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          ${content}
        </div>
      </div>
    </div>
  `;
}

function closeModal() {
  document.getElementById('modalContainer').innerHTML = '';
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    closeModal();
  }
});
</script>
